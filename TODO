/* -*- shiftwidth: 4; softtabstop: 4 -*- */

BUGS:
        - Restriction is not waterproof: some local sites don't get shown, like
          markas-al-nour.org which gets wrongly resolved by internal zentyal-boxes
          eventually also problems with local logins
	- 10 crashes when not operating "properly"
	
[5', 15', 30', 1h, 4h]
Security:
	-3 PersonModify - only allow to change password from persons which have equal or
	  lower rights - use an own tab which is not active for non-allowed users

UI:
        - clean up the interface, mostly the tabs and sub-tabs
        - write a good documentation...

FEATURES:
        -3 Print student-cards the Markas-way with the idea of Josue and Viviane
	-4 Courses::Days - add other days to the list
	-3 check diploma-templates
        -2 Rename course
	- AfriCompta-support:
		-4 Don't show archived and deleted accounts, but do stats on them
		-3 Delete accounts

Programming:
        -2 verify if Person::data_set and Person::data_set_log are really
          necessary
        -3 change Course::make_pdfs to OpenPrint

> 1.0
Features:
        -3 Add a status-bar on bottom for progresses and information like:
           printing, progress, messages, connect/disconnect, ...
	-3 Admin::Restore - show progress
	-3 Import attestation.markas-al-nour.wifi
	-4 make an asynchronous printing-module
	- Using data from solar on local account without failing
	- Make a dropbox when using _find
	- Graying out fields not usable (PersonModify, CashAdd, ...)
        - AfriCompta-support:
		-4 Define reports
	-2 Make internet.wifi with Self::Internet only, and a link which allows
	  to do the infamous internet.wifi/?pass=&user=
        -3 take Admin::ControlAccess from Rooms-definition
	-Tigo
          - 3 auto-reconnect on error
          - Ajouter
            AT+CREG? pour l'id de la cellule
            AT+CSQ pour voir la qualité
            AT+COPS=? pour voir les fournisseurs
          - vérifier si la sim est expirée
          - Montrer le log des derniers communications avec le Modem
	-3 Inventory of screens, mice, routers
	-4 Double-users: merge them and avoid them in the first place
	- CourseHistory - what should go in there?

Programming:
	-2 Allow subdirectories in Entities-directory
	-3 Remove QooxView/Storages/AfriCompta.rb and adjust
	 Gestion/Entities/Person.rb
	-3 add a print-dialog with window and buttons
	-3 Change Frontend::Views::LTab::dispatch to handle one request at a
	  time and to allow new requests to be inserted before handling other
	  requests -> doing a reply( parent->switch_tab ) + reply( switch_tab )
	  should switch the tab in the NEW parent-tab!
	-3 kill Layout.js::dispatch::init_values, as it is not needed anymore with
	  the RPC-queue enabled (even though I'm nut sure the latter really works...)
	-3 when empty configuration and LDAP is not here, fall back to CSV
	-3 Add real type-checking between value_* and Storages
	-4 rpc_parse_reply
		- take out arrays when only one reply anyway
	- Really slow search or something when starting up
		- also in CourseModify
	- having lists and dropbox with additional hidden "index" that is returned for chosen entries
		- Tasks reference a "person" which can change instead of a "person_id"
		- Can't change name of courses
		- Add a method "select" instead of sending a list-item twice
	- make class to easy allow for a "add/delete"-list
	- ENTITY_BASE:
		- Have one tab with all Entities to chose from
		- Other tabs with actions on each entity
		- Recognize entities from View-name
			- PersonCourseModify has a person and a course entity chosen, available
			 through session.chosen.Person and session.chosen.Course
		- cleanup:
			- arrays with strings coming from Frontend ?!?
			- Cash* views have to be moved, as there is no "Cash"-Entity
		- convert views to value_entities
	- DOMINIQUE:
		- Statistiques de "Cours::accounting"
		- Bibliotheque

VERIFY:

Rare bugs:
	- Better check of LDAP-dependency: if /etc/*/ldapscripts.conf is here,
	  use that one. Don't rely on Gestion/ldap.secret!
	- adding an already existing user crashes if he has been added outside
	  of Gestion: CourseModify::add_students doesn't work sometimes 
          (when there is a stale uid of a removed user)
	- check why ruby-gettext from debian/squeeze messes things up

Unconfirmed bugs:
        - ??? Wrong printer-dialog in Cours/Attestations/Print
	- PersonAdd - password is not stored - not repeatable
	- Default focus and button:
		- Frontend: when pressing a button, focus doesn't go back to the "std-focus"-element
			-> where is that a problem?
	- TaskList: sometimes when pressing "list", it takes twice to show everything

To check:
        - printing of student-card with accent in name fails (probably due to
          accent in filename - sanitize using "accents_replace")


** FIXED **:
        - P 130221: change all cash-methods to credit-methods
        - P 130221: add a AddCash-permission and change Person.setup_instance
        - P 130221: change Person::credit to Person::internet_credit
        - P 130221: change config::compta_due to config::account::cash
        - P 130221: change Person::credit_due to Person::account_total_due
        - P 130221: change Person::compta_due to Person::account_due
        - P 130221: change Person::account_* to Person::account_name_*
        - B 130219: don't get printers for remote users on Windows ->
          uses config:OpenPrint:search_remote for regexp on who is searched - refuses
          Windows computers anyway
        - B 130219: Why does it sometimes redirect to stuff like http://admin:3302/?afdj ??
          -> send proper files and do some regex-magic in Frontend/Lib/RPC.js
        - B 130219: put full match first in Person::search
        - B 130219: When creating a username from "name1 name2 name3 name4", it gets to
          "n3_name1_name2" instead of "n3_name1"
        - B 130219: when adding "cybermanager" to a person, account is not created
        - B 130219: Can't print presence-list
        - TC130205: Why are the people refused in Info.rb? -> Added FlagInternetFree
        - TC130205: FreeInternet for paying internet is not to be used
        - F 130205: add list of "add_promotion"
        - B 130201: admin created repeatedly? Why? To secure in case of bug...
	- UI130201: 2/4 PrintButton - Have a SplitButton with PDF and printers from local
         and remote computer - added config::OpenPrint::update_remote
        - F 130201: 2/5 Transfer money from one account to another directly in the interface
        - B 130201: creation of accounts is not reliable. Probably fields of
          Person::account_due and Person::account_cash are not automatically
          filled in
        - B 130201: accounts are mixed - account_due in Admin::Transfer is same for all...
        - B 130201: when user connected and no credit, then credit is added, it doesn't
         show in the user's interface
        - B 130123: Course::Modify::assistant doesn't work as expected: null is not
          stored correctly and returns as [0], whereas the other return as
          2
        - F 130123: Added a simple ticket-system
	- NB130123: AfriCompta::check doesn't work anymore - couldn't reproduce
	- P 130115: 4 Correctly delete accounts and migrate through AfriCompta
        - P 130115: 4 Correctly archive accounts and keep total only of selected ones
        - UI130108: keep focus for <enter> in current group
        - B 130108: Auto-update = 0 makes reload very fast -> Course:Diplomas:do_diplomas
        - F 130108: 2/3.5 Use Entities in Course::Modify
        - B 130105: 2/3 keep session-ids over restarts
        - B 130105: when Gestion.rb is restarted, and a connected user wants to use it,
         it crashes
        - B 121219: Reload Gestion if it fails, log everything
        - B 121213: Crashes on Self::Cash
        - UI121213: "local" printer is in fact "server"
        - F 121213: Ajouter permissions "internet" to new users
        - B 121212: Course::Modify::Print without student selected still shows
         pop-up window
        - B 121211: When deleting course, its data is stille displayed
        - F 121210: Use Inventory::Rooms in Cours::Modify
        - F 121210: Delete courses
	- F 121206: Migration of new data-types: have defaults and offer
         migration-support when changing values
	- UI121206: Cours::Noter should have a bigger and longer student-list
        - F 121206:  Add a working "version" to the welcome-screen, including
          main, sub and local versions (0.9.1-altatawwur)
        - B 121206: When showing Self::Cash, some entries may be shown double or
          triple, leading to an error "no multi selections in single mode"
          -> add an option to "show_txt" to not select upon double-lines
          (which was a stupid hack in the first time anyway)
        - F 121130: Use accounts in Self::Cash instead of LogActions
	- B 121130: Mon Compte - Dépenses is not updated, because it relies on LogAction
        - F 121129: Import old credits -> Admin::Credit
        - B 121129: Adding credit to a person who has nothing results in
          0 credit -> insert .to_i
        - B 121129: when only sub-tabs are visible (like "student"), it doesn't get unfaded
        - B 121129: why are all accounts checked for AfriCompta when autosaving?
          -> because of Internet::check_services
        - B 121129: connection::permanent and can_connect, show correct status
          in Self::Internet
        - F 121127: Automatically taking into account no-promotion settings
	- F 121127: When no promotion left, show only "disconnect"-button
	- B 121126: When sending something from "Frontend", stop the timer, then
	 restart it when the answer arrives
        - B 121126: Person::Tabs gets enabled before it gets unfaded
        - B 121122: First tabs shouldn't be clickable (while waiting to be positioned
         as should)
	- B 121122: Retirer le droit de noter a Secretaire
        - B 121122: empty tab gives an error: if a user doesn't have the right to
          any tab, the parent is ds
	- B 121122: if teacher has permission AdminAccess and AdminAccess.visible=false, it fails
        - F 121116: AfriCompta-support:
		- 120724 - Add Account and Movement
		- 120912 - Gestion acts like a server, and clients can merge with it
		- 120924 - Synchronize with AfriCompta
		- 120925 - Update Person-class to use new AfriCompta
		- 121025 - Archive old accounts
		- 121116 - Use accounts for internet-cash
        - B 121122: save in Course::Modify doesn't work anymore!
        - B 121122: All kinds of flickering and enabled buttons fixed
	- B 121121: when clicking on tab while other tab is loading, it loops endlessly
	- B 121121: Windows don't get hidden when working (CourseModify::bulkAdd)
	- B 121120: When Cours::Modify modifying a student, it might get the wrong
	 one if there is another student who starts with the same name
	- B 121120: Don't search in Person::Tabs when there are less than 3 chars
	 and only return 20 results
	- F 121117: Person::print - put into directory
	- B 121116: Personnes - Admin is not always updated
	- UF121116: Kick user when he's idle for 2-4 minutes
	- UI121116: Traduction des nouveautés
	- B 121116: Vider liste dans "bulk add" quand dernier étudiant
	- B 121116: Capitalise les prénoms et noms de famille
	- UI121116: Students::bulk_add doesn't add e-mail
	- B 121116: Auto-update continues to be called, even when view is changed!
	- B 121116: Login - permettre espaces avant et après le nom
	- UI121116: credit-add is in its own tab
	- UI121116: read-only fields are better marked
	- UI121116: Tigo - estimate bytes left
	- B 121116: Tigo - promotion add only works on command-line
	- B 121116: Admin::Internet - adjust for new lib_net
	- F 121116: Internet - reduce money
	- F 121116: Internet - no money -> no connection
	- F 121116: Internet - show status in Self::Internet
	- B 121116: block - command not found
	- UI121116: Internet - show connected / disconnected even when first viewed
	- F 121116: Chat - added a simple chat-module
	- F 121106: Add a "role"-field to user, that can be used in the Diplomas
	- B 121106: doesn't work anymore for signing up new students
	- B 121030: when no student passes, it crashes
	- B 121025: Why is account.total not updated? old stuff, put a button
	- B 121025: Make rounding in Account-total
	- B 121024: Why is account.movements.each{|m| m.to_json} so slow? account.update_total?
	    - dputs is evaluated even for not-shown levels, fixed
	- B 121019: - credit and lock_hours are not in LDAP anymore
	- B 121005: - Speeding up of Tigo
	  - Account-creation when starting up
	  - QooxView/Tests are not running through
	- B 120925 - AfriCompta: test creation of accounts on both sides, when using
	  AfriCompta.new and Persons.add_cash
	- F 120718 - Have multiple course-types with own templates
	- B 120623 - Sometimes Diplomas/* gets deleted! BAD - Course.diploma_dir didn't get udpated
				- different small bugs in diploma-handling
	- F 120623 - Added blocking of computers (at least front-end, still need to do iptables)
	- P 120623 - Entity corresponding to Entities is created automatically - more concise, but
				bug-prone...
	- B 120619 - No PDF-export in Person::Modify::Print, Person::Add::Print
	- B 120614 - New installation under Lubuntu1204 should work
				- DropDown don't update on changes:
					- Inventory::Computers::rooms doesn't update on new rooms
					- Course::Modify::teachers don't update on new teachers
				- Self::Cash doesn't update
				- person is not displayed correctly:
					1. Person::search viviane
					2. AdminPerson
					3. Cours
					4. Check cours
					5. Modify Student
					6. AdminPerson still shows viviane
					7. switching to ModifyPerson doesn't work
				- Add PDF-export if printer is empty
	- B 120605 - Change lots of ids and stuff to value_entity
				 - Tested adding CourseModify::another, but troubles of having the
		  		  right amount of [] everywhere
	- UF  	   - Clicking on Self::Cash puts back to PersonModify
			   - Widen "students"-field so that all text fits in CourseGrade
			   - Delete CourseModify::add_students and put courses to add in PersonModify
	- B 120602 - Addcredit doesn't work anymore
			   - add test for LogActions
			   - add password-changes to logactions
			   - Add logging to all Person-changes
			   - Lots of changes in Person and Entity::set_data* - have to check
	- P 120602 - change Entity::(data_set|set_data|set_entry) to a more meaningful set
				 - took data_set, data_set_hash and data_set_log
	- B 120530 - QooxDoo-error when viewing Admin-tabs (fade on not yet visible elements)
			   - Command-line options different for tests and real
			   - QooxDoo-error when no elements in parent-tab
			   - Add a method "focus" to Frontend - doesn't work in PersonTabs
			   - some operations are very slow
			     - CashAdd takes time to fill up the whole log - is not standard anymore
			   - When adding a person twice to a course, he appears twice in the course
	- B 120528 - VTListPane: when adding new elements, "null" appears
			   - value_entity: is not saved
	  P 120528 - value_entity: - also do show_entity
	- B 120526 - Adding PersonAdmin::account_due doesn't allow user to use AfriCompta
	  			 directly
	- B 120524 - PersonModify - Everything is gone when the password is changed
			   - PersonAdmin - InternetNone keeps values when switching user...
			   - When adding cash in PersonModify, it doesn't show in the user
	- B 120523 - CourseModify - editStudent doesn't work
				- parents( switch_tab, update ) doesn't work as supposed, as the
		  		  rpc_calls from "switch_tab" get done after "update". Add a local
		  		  variable to each parent-tab which holds eventual values to be over-
		  		  written to the available values
			   - PersonAdd - should directly open in PersonTabs
			   - When switching from/to CourseTabs, course is not highlighted anymore
	- B 120522 - CoursTabs - add should be in its own tab, delete protected
	- B 120522 - Permissions are mangled with tabs...
	- UI120517 - Resizing is nicer for login-screen again
	- B 120516 - add translation for tab-names
	- B 120516 - CourseTabs - new_course doesn't work
	- B 120515 - CourseModify waits for all students to populate
	- UI120515 - Replace text-field in info-boxes with HTML-field 
	- UI120515 - Moved all tabs into sub-tabs
	- B 120511 - *Tabs: error in CoursGrade when selected a course and multiply switch back
		and forth to it
	- B 120511 - *Tabs: horizontal scrolling-bar is missing in sub-tabs
	- B 120509 - *Tabs: when changing sub-tabs, the field-elements of the *Tab should be sent over,
		especially in Course*
	- UI120504 - Make 2-dimensional field with "Course, Person, Cash, ..." on left and rest inside from top
	- F 120503 - use language file to replace name of the fields
	- B 120331 - Wrong order in View::rpc_update_view
	- B 120328 - cash doesn't show up in CashAdd - oups, error in LogActions!
	- P 120327 - change value_entity_Persons to value_entity_person
	- P 120326 - Make value_entity a reality!
		120323 - added first code.
		120324 - do code in Value.to_a for entity
		120324 - push entity with "id:name" in Value.to_a
		120326 - View.rpc_parse_reply searches for entities and converts them back
	- P 120323: Further automize: Take first part of View-class as the standard entity,
		only if the specific entity exists
	- T 120323: All test cases work
	- F 120317: Added "carte_etudiant" and "fiche_presence" in the CourseModify-view
	- B 120317: OpenOffice doesn't work on MacOSX - fixed, was space in path...
	- B 120312: Gestion crashes on MultiJSON with Ubuntu 1004
	- AC120127: Start with SQLite-StorageType
	- EB120107: @data_class has to be kept for general use and not for classes that
		know their Entity
			- get_entity is used for Person-class only anyway, so let's drop it
			- Session gets new instance variable "owner" instead of Person
	- EB120102: "sid" is replaced with "session", and has members that allow to
	    access already chosen entities
	    - Add class Session
	    - move session-ids from "Permission" to here
	- B 120102: Are all necessary views shown? - yes
	- B 120102: PersonShow doesn't work anymore - fixed
	- B 111216: CourseGrade: all teachers can grade all courses - only appropriate teachers should be able to grade
	- UF111216: CourseModify: Copy "description" and "contents" when creating new course
	- B 111215: CourseModify: "students" is not deleted when clicking tab
	- UF111215: CourseModify: Add a "Edit user"-button
	- B 111215: when changing name in CourseGrade:: "students" is not updated
	- B 111209: Adding new students in CourseModify::bulk_add, doesn't add to markas-al-nour.org
	- UF111208: Adding a new person only with one field, like CourseModify::bulk_add
	- UF111208: students-listings include user-name and password
	- B 111208: CourseModify::del_student - login-names pop up in "students"
	- B 111108: Windows:
		- Make also focus for windows
		- window that pops up on wrong password is not in front
		- When a window is shown, hide the rest
		- Use first_button from windows
    - B 111105: Course
		- diplomaDir doesn't have default value
		- do files in alphabetical order
	- B 111021: CourseDiploma: 
		- update automatically
		- make print work
	- B 111006: Crash: CourseModify, chose course, PersonModify, CourseModify
	- B 111006: Accelerate saving of LogActions - don't save everything all the time
	- B 111101: PersonModify: internet_none can't be deleted
	- B 111101: PersonModify: permissions are not cleard from one user to another
	- B 110930: DropBoxes are not updated:
		- TaskEdit: "client" and "person" should get new entries automatically
		- CourseModify: "teacher" and "assistant"
		- Adding or changing names of persons is not reflected in list_drop (see TaskList)
	- B 110930: Lists are not updated:
		- CourseModify: students_win::students_add
	- P 110929: VTListPane using new [index,text]-lists
	- B 110929: TaskEdit: can't have two tasks the same date
	- UF110929: TaskList: give tasks in chronological order w/o name and w/o "-" at start 
	- B 110909: When adding too many users in CourseModify::bulk_add, it crashes due to a timeout
		in the RPC-handler -> add one user at the time, and give feedback between front and back
	- UF110908: CourseGrade: 
		- when selecting a course, cursor goes to "mean"
		- when pressing "save", cursor goes to "mean"
	- UF110906: Show "wrong password" or "no permission"
	- UF110906: CourseGrade: 
		- when selecting a course, first user is selected
		- when pressing "save", next user is selected
	- F 110906: Course::list_courses respects dates
	- B 110827: TaskList: error on listing years as integers
	- B 110827: TaskEdit: when adding a task and entering a date like "22.6.11", it crashes
	- B 110827: CourseModify::add_course not working correctly - forgot a "+"
	- B 110827: Selecting course "base_1104" in CourseModify or CourseGrade, selection isn't shown.
	            Probably because index is 0 - yup, this was not good
	- B 110722: Multiple wrong datasets with regard to array/string 
	- P 110722: Code duplication in Frontend/Lib/Fields.js
	- UF110718: Change the way new users are created: make a new PersonAdd-view
	- B 110712-110716: CourseModify::add_students doesn't integrate in Moodle / Captive:
		- scripts called when adding student
		- new service for internal stuff to check for students and other things
		- call moodle to activate new student
	- B 110711: Persons::data_create doesn't copy directory to buzz
	- B 110711: PersonModify::birthday is not deleted
	- WL110707: Dominique - Coût du cours - Rémunération du prof et de l'assistant 
				- Nombre d'étudiants qui ont fini
	- UF110707: Don't call _find for each new letter, but only after 1.5 seconds and gray out
	- B 110707: When clicking 'add_block', permissions get deleted!
	- B 110707: Students grades are not saved!
	- F 110703: being able to sign in students and give notes
	- F 110701: Easy entering of students for courses
	- B 110701: Took out PersonModify::groups and CashAdd::services_active as it doesn't
	  			work yet
	- B 110701: Leftover choices in PersonModify::permissions
	- B 110701: Data of lists coming back which give the chosen ones don't work with
	  			"save" and probably other stuff. Problem: choice <> data, but it's what
	  			is saved :( - delete list of things we don't want
	- B 110630: internet_none disappears when saved from PersonModify, as the Frontend only sends
	  			back an empty array (because nothing is chosen)
	- B 110630: internet_none is parsed wrongly from LDAP-entry (PersonModify)
	- B 110630: internet_none is not cleared when user changes (PersonModify)
	- B 110630: CSV-data gets lost from time to time!!!
				created first a .tmp-file, then "mv csv.tmp csv"
	- B 110630: Changing tabs when starting up doesn't work - blocking when starting up
	- F 110630: change password with LDAP
	- B 110630: LDAP create doesn't add MaN-Cash-field
	- B 110630: LDAP create doesn't fetch right uid
	- F 110629: CourseModify-Windows should close on adding a course or students
	- F 110628: LDAP doesn't create a new entry
	- F 110627: Students are not really linked to Courses
				possible to add and delete studdents
	- B 110627: Prevent clients fields from overwriting users fields (credit_due in CashAdd and others)
	- F make windows available with a label (for window_show and window_hide)
	- B Changing tabs while old tab is still loading creates an error
	- B Changing date in TaskList gives error
	- B 110602: Entities.data and Entity.data are not synched - why aren't they the same anyway?
	- F 110601: List-methods in View-shows don't get updated automatically
